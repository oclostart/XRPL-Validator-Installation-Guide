# List Block Devices - Confirm the OS detects the 2nd physical/logical drive, usually sdb. The OS drive and USB Flash Drive (if still connected) will appear here as well.
lsblk

# Partition the sdb disk for the rippled db and log file
sudo fdisk /dev/sdb

# Select new partition
n
ENTER

# Select Primary (default)
ENTER

# Select Partition Number 1 (default)
ENTER

# Select First Sector (default 2048)
ENTER

# Select Last Sector (default = use full disk)
ENTER

# Save changes and exit
w

# Create an ext4 filesystem on sdb and set /dev/sdb1 as its partition
sudo mkfs.ext4 /dev/sdb1

# Create a mount point for sdb
sudo mkdir /mnt/rippled_data

# Correlate the partition to the mount point
sudo mount /dev/sdb1 /mnt/rippled_data

# Reclaim the 5% ext4 disk space reserve on sdb1
sudo tune2fs -m 0 /dev/sdb1

# Copy or take a picture of the sdb1 UUID
sudo blkid

# Edit fstab to automatically mount sdb at bootup with noatime
sudo nano /etc/fstab

# Enter the following text including the comment "# rippled_data mount configuration"

# rippled_data mount configuration
UUID= YourSdbUUID /mnt/rippled_data ext4 defaults,noatime 0 2

# Save and exit
CTRL+O
ENTER
CTRL+X

# Update and install repos
sudo apt -y update
sudo apt upgrade -y

# Install utilities
sudo apt -y install apt-transport-https ca-certificates wget gnupg

# Add Ripple's package-signing GPG key to your list of trusted keys
sudo install -m 0755 -d /etc/apt/keyrings && \
    wget -qO- https://repos.ripple.com/repos/api/gpg/key/public | \
    sudo gpg --dearmor -o /etc/apt/keyrings/ripple.gpg

# Check the fingerprint of the newly-added key
gpg --show-keys /etc/apt/keyrings/ripple.gpg

# Confirm the result from the command above matches the info below
# pub   rsa3072 2019-02-14 [SC] [expires: 2026-02-17]
#     C0010EC205B35A3310DC90DE395F97FFCCAFD9A2
# uid           TechOps Team at Ripple <techops+rippled@ripple.com>
# sub   rsa3072 2019-02-14 [E] [expires: 2026-02-17]

# Add the appropriate Ripple repository for your operating system version: Ubuntu 24.04.02
echo "deb [signed-by=/etc/apt/keyrings/ripple.gpg] https://repos.ripple.com/repos/rippled-deb noble stable" | \
    sudo tee -a /etc/apt/sources.list.d/ripple.list

# Update the package index to include Ripple's repo and install rippled.
sudo apt -y update && sudo apt -y install rippled

# You can confirm the status of the rippled service
systemctl status rippled.service

# Stop rippled service
sudo systemctl stop rippled

# Create new database & log directories
sudo mkdir -p /mnt/rippled_data/rippled/db/nudb
sudo mkdir -p /mnt/rippled_data/rippled/logs

# Set ownership & permission
sudo chown -R rippled:rippled /mnt/rippled_data/rippled/db
sudo chmod -R 750 /mnt/rippled_data/rippled/db
sudo chown rippled:rippled /mnt/rippled_data/rippled/logs
sudo chmod 750 /mnt/rippled_data/rippled/logs

# Update rippled.cfg
sudo nano /etc/opt/ripple/rippled.cfg

# Update the following under [node_db]
path=/mnt/rippled_data/rippled/db/nudb
online_delete=750000

# Update the following under [database_path]
/mnt/rippled_data/rippled/db

# Update the following under [node_size]
huge

# Update the following under [debug_logfile]
/mnt/rippled_data/rippled/logs/debug.log

# Save and exit
CTRL+O
ENTER
CTRL+X

# Start and enable rippled
sudo systemctl start rippled
sudo systemctl enable rippled

# Verify rippled service
rippled server_info
systemctl status rippled.service

# Delete old database and log directories
sudo rm -rf /var/lib/rippled/db
sudo rm -rf /var/log/rippled

# Disable swappiness
cat /proc/sys/vm/swappiness
sudo nano /etc/sysctl.conf
vm.swappiness=0
sudo sysctl -p /etc/sysctl.conf

# Set up rippled core dumpbs
sudo apt update
sudo apt install -y rippled-dbgsym
ulimit -c unlimited
sudo systemctl edit rippled

[Service]
LimitCORE=infinity

# Save and exit
CTRL+O
ENTER
CTRL+X

# Reload system config
sudo systemctl daemon-reload

# Restart rippled
sudo systemctl restart rippled
